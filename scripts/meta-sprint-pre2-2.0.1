#!/bin/bash
# meta-meta script by Ed Cates
# modified by Rod Whitby
# intended to flash Sprint Pre phones with a working webOS 2.1 image
#  Your mileage may vary

[ -d scripts ] || { echo "Run the script from the meta-doctor directory, not the scripts directory" ; exit ; }

CDMA_JAR_URL="http://palm.cdnetworks.net/rom/pre2/p201r0d02172011/ver1z0np201rod/webosdoctorp102verizonwireless.jar"
W201_JAR_URL="http://palm.cdnetworks.net/rom/pre2/p201r0d11242010/wrep201rod/webosdoctorp102ueuna-wr.jar"

CDMA_FILE="webosdoctorp102verizonwireless-2.0.1.jar"
W201_FILE="webosdoctorp102ueuna-wr-2.0.1.jar"

CDMA_BUILD="pre2-p102eww-verizonwireless-2.0.1"
W201_BUILD="pre2-p102ueuna-wr-2.0.1"

PATIENT="meta-sprint-pre2-2.0.1"

git="git"
wget="wget"
make="make"
java="java"
patch="patch"
tar="tar"
python="python"

if [ "`uname -s`" == "Darwin" ] ; then 
    tar=gnutar
    export COPYFILE_DISABLE=true
    export COPY_EXTENDED_ATTRIBUTES_DISABLE=true
fi

WEBOS_TARBALL="webOS.tar"
CDMA_FW="roadrunnercdma_fw.tar"

for f in $git $wget $make $java $patch $python $tar ; do
	
    which $f > /dev/null || { echo "Cannot find $f.  Please install it." ; exit ; }

done

ARGS=
if [ "$1" = "--wifi-only" ] ; then
    ARGS="BYPASS_ACTIVATION=1 BYPASS_FIRST_USE_APP=1 DISABLE_MODEM_UPDATE=1"
fi

ARGS="${ARGS} ENABLE_DEVELOPER_MODE=1 DISABLE_UPLOAD_DAEMON=1 CUSTOM_WEBOS_TARBALL=${WEBOS_TARBALL} PATIENT=${PATIENT} DEVICE=pre2 CARRIER=wr"

$make ${ARGS} settings

echo
echo "Your custom doctor file will be created at build/${PATIENT}/${W201_FILE}"
echo

mkdir -p downloads

[ ! -f downloads/${CDMA_FILE} ] && $wget -c ${CDMA_JAR_URL} -O downloads/${CDMA_FILE}
[ ! -f downloads/${W201_FILE} ] && $wget -c ${W201_JAR_URL} -O downloads/${W201_FILE}

# $make clobber

$make VERSION=2.0.1 DEVICE=pre2 CARRIER=verizonwireless unpack || exit
$make VERSION=2.0.1 DEVICE=pre2 CARRIER=wr unpack || exit

cp build/${W201_BUILD}/resources/${WEBOS_TARBALL} ./

cp build/${CDMA_BUILD}/webOS/${CDMA_FW} ${CDMA_FW}

$tar -C ./ -f ./${WEBOS_TARBALL} --delete ./${CDMA_FW} || exit
$tar -C ./ -f ./${WEBOS_TARBALL} --append ./${CDMA_FW} || exit

$make ${ARGS} clobber-build all || exit

$java -jar build/${PATIENT}/${W201_FILE}

rm -f ${CDMA_FW} ${WEBOS_TARBALL}

