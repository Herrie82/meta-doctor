#!/bin/bash
# meta-wr-pre-2.1.0 script by Rod Whitby
# based on meta-meta script by Ed Cates
# intended to flash WR Pre phones with a working webOS 2.1 image
#  Your mileage may vary

[ -d scripts ] || { echo "Run the script from the meta-doctor directory, not the scripts directory" ; exit ; }

P100_JAR_URL="http://palm.cdnetworks.net/rom/pre/p145r0d06302010/eudep145rod/webosdoctorp100ueu-wr.jar"
P101_JAR_URL="http://palm.cdnetworks.net/rom/preplus/p210r0d02212011/eudep210rod/webosdoctorp101ueude-wr.jar"

P100_FILE="webosdoctorp100ueu-wr-1.4.5.jar"
P101_FILE="webosdoctorp101ueude-wr-2.1.0.jar"

P100_BUILD="pre-p100ueu-wr-1.4.5"
P101_BUILD="preplus-p101ueude-wr-2.1.0"

git="git"
wget="wget"
make="make"
java="java"
patch="patch"
tar="tar"

if [ "`uname -s`" == "Darwin" ] ; then 
    tar=gnutar
    export COPYFILE_DISABLE=true
    export COPY_EXTENDED_ATTRIBUTES_DISABLE=true
fi

BLD_INFO="palm-build-info"

for f in $git $wget $make $java $patch; do
	
    which $f > /dev/null || { echo "Cannot find $f.  Please install it." ; exit ; }

done

ARGS=
if [ "$1" = "--wifi-only" ] ; then
    ARGS="BYPASS_ACTIVATION=1 BYPASS_FIRST_USE_APP=1"
fi

ARGS="${ARGS} ENABLE_DEVELOPER_MODE=1 DISABLE_UPLOAD_DAEMON=1 DISABLE_UPDATE_DAEMON=1 CUSTOM_MODEL_LIST=P100UEU CUSTOM_WEBOS_DMSET=312 CUSTOM_CARRIER_DMSET=317 CUSTOM_BUILD_INFO=palm-build-info DEVICE=preplus CARRIER=wr"

$make ${ARGS} settings

mkdir -p downloads

[ ! -f downloads/${P100_FILE} ] && $wget -c ${P100_JAR_URL} -O downloads/${P100_FILE}
[ ! -f downloads/${P101_FILE} ] && $wget -c ${P101_JAR_URL} -O downloads/${P101_FILE}

$make clobber

$make VERSION=1.4.5 DEVICE=pre CARRIER=wr unpack || exit
$make VERSION=2.1.0 DEVICE=preplus CARRIER=wr unpack || exit

cp build/${P100_BUILD}/rootfs/etc/${BLD_INFO} ./

cp build/${P101_BUILD}/rootfs/etc/${BLD_INFO} ./${BLD_INFO}-unmasqed

$make clobber

$make ${ARGS} all || exit

$java -jar build/${P101_BUILD}/${P101_FILE}
